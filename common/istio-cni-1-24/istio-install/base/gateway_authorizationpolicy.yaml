# Allow all traffic to the istio-ingressgateway
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: istio-ingressgateway
  namespace: istio-system
spec:
  action: ALLOW
  selector:
    # Same as the istio-ingressgateway Service selector
    matchLabels:
      app: istio-ingressgateway
      istio: ingressgateway
  rules:
  - {}
---
# Allow all traffic to the kubeflow-gateway (Gateway API)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: kubeflow-gateway-allow-all
  namespace: istio-system
spec:
  action: ALLOW
  selector:
    matchLabels:
      gateway.networking.k8s.io/gateway-name: kubeflow-gateway
  rules:
  - {}
---
# RequestAuthentication for Gateway API
apiVersion: security.istio.io/v1
kind: RequestAuthentication
metadata:
  name: dex-jwt-gateway-api
  namespace: istio-system
spec:
  jwtRules:
  - forwardOriginalToken: true
    fromHeaders:
    - name: Authorization
      prefix: 'Bearer '
    issuer: http://dex.auth.svc.cluster.local:5556/dex
    outputClaimToHeaders:
    - claim: email
      header: kubeflow-userid
    - claim: groups
      header: kubeflow-groups
  selector:
    matchLabels:
      gateway.networking.k8s.io/gateway-name: kubeflow-gateway
