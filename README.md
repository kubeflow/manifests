# Manifests
This repo is a [bespoke configuration](https://github.com/kubernetes-sigs/kustomize/blob/master/docs/glossary.md#bespoke-configuration) of kustomize targets used by kubeflow. These targets are traversed by kubeflow's CLI `kfctl`. Each target is compatible with the kustomize CLI and can be processed indendently by kubectl or the kustomize command. 

## Organization
Each directory leaf node within the repo contains a kustomize target (base or overlay). Currently overlays hold platform resources, so an overlay subdirectory is one of "gcp|minikube". These targets are processed by kfctl during generate and apply phases and is detailed in [Kfctl Processing](#kfctl_processing), however generating yaml output for any target can be done in the following way:

### Install Kustomize

`go get -u github.com/kubernetes-sigs/kustomize`

### Kustomize CLI Usage

```bash
git clone https://github.com/kubeflow/manifests
cd manifests
kustomize build | kubectl apply -f
```

## Kfctl Processing 
Kfctl will traverse these directories to find and build kustomize targets based on it's configuration file `app.yaml`. Each target processed by kfctl will result in an output yaml file. The output file is generated by calling kustomize's API.  The kustomize package manager in kfctl will read app.yaml and apply the packages, components and componentParams to kustomize in the following way:

- packages are always top-level directories under the manifests repo
- all components are also directories but may be a subdirectory in a package.
  - components may be a top-level directory if there is a base, overlay in that directory and the component name is equal to the package name. 
  - otherwise a component is a sub-directory whose name matches the component name in app.yaml.
- component parameters are applied to a component's params.env file which must contain an entry whose key matches the component parameter. The params.env file is used to generate a ConfigMap. Entries in params.env are resolved as kustomize vars or referenced in a deployment or statefulset env section.
- components are output as `<component>.yaml` under the kustomize subdirectory after `kfctl generate...`. 


Inputs to kfctl:

```
application   ⇲
argo          ⇲
common        ⇲
              ⎹→ambassador
              ⎹→basic-auth
              ⎹→centraldashboard
              ⎹→echo-server
              ⎹→spartakus
gcp           ⇲                                   
              ⎹→cert-manager
              ⎹→cloud-endpoints
              ⎹→gcp-credentials-admission-webhook
              ⎹→gpu-driver
              ⎹→iap-ingress
              ⎹→metric-collector
              ⎹→prometheus
jupyter        ⇲                                   
              ⎹→jupyter
              ⎹→jupyter-web-app
              ⎹→notebook-controller
katib         ⇲                                   
kubebench     ⇲                                   
metacontroller⇲                                   
pipeline      ⇲                                   
              ⎹→minio
              ⎹→mysql
              ⎹→persistent-agent
              ⎹→pipelines-runner
              ⎹→pipelines-ui
              ⎹→pipelines-viewer
              ⎹→scheduledworkflow
```

Outputs from kfctl (no platform):
<deployment>  ⇲
              ⎹→kustomize
                        ⎹→ambassador.yaml
                        ⎹→application.yaml
                        ⎹→argo.yaml
                        ⎹→centraldashboard.yaml
                        ⎹→jupyter-web-app.yaml
                        ⎹→metacontroller.yaml
                        ⎹→notebook-controller.yaml
                        ⎹→pipeline.yaml
                        ⎹→profiles.yaml
                        ⎹→pytorch-operator.yaml
                        ⎹→tensorboard.yaml
                        ⎹→tf-job-operator.yaml


## Best practices for kustomize targets

- use name prefixes if possible for the set of resources bundled by a target
- do not set namespace in the resources, this will be done by a higher level target


### Bridging kustomize and ksonnet

Equivalent to parameters in ksonnet, kustomize has vars. But the customizable objects are limited to [this list](https://github.com/kubernetes-sigs/kustomize/blob/master/pkg/transformers/config/defaultconfig/varreference.go)

### Installing to a custom namespace

For example, to install in `kubeflow-dev`. From the root of the repo run:

```bash
kustomize edit set namespace kubeflow-dev
```
