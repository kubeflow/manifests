apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: kfctl-e2e
spec:
  inputs:
    resources:
    - name: image
      type: image
    params:
    - name: image
      type: string
      description: the image name
    - name: project
      type: string
      description: the gcp project to run the e2e tests
    - name: config_file
      type: string
      description: the location of the prow_config file
    - name: cluster
      type: string
      description: name of k8 cluster
    - name: bucket
      type: string
      description: name of gcp bucket to store test results
    - name: REPO_OWNER
      type: string
      description: git repository org
    - name: REPO_NAME
      type: string
      description: git repository name
    - name: repos_dir
      type: string
      description: path to where the repo is downloaded
    - name: zone
      type: string
      description: k8 zone where e2e tests run
    image: "${image}"
    command: ["python"]
    args:
    - "-m"
    - "kubeflow.testing.run_e2e_workflow"
    - "--project"
    - "${project}"
    - "--zone"
    - "${zone}"
    - "--cluster"
    - "${cluster}"
    - "--bucket"
    - "${bucket}"
    - "--config_file"
    - "${config_file}"
    - "--repos_dir"
    - "${repos_dir}"
    env:
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: /secret/kaniko-secret.json
    - name: CLIENT_ID
      valueFrom:
        secretKeyRef:
          name: client-secret
          key: CLIENT_ID
    - name: CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: client-secret
          key: CLIENT_SECRET
    volumeMounts:
    - name: kaniko-secret
      mountPath: /secret
    - name: kubeflow
      mountPath: /kubeflow
  volumes:
  - name: kaniko-secret
    secret:
      secretName: kaniko-secret
  - name: kubeflow
    persistentVolumeClaim:
      claimName: kubeflow-pvc
