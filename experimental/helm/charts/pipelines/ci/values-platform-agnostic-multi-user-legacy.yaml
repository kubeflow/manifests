# Platform-Agnostic Multi-User Legacy Configuration

global:
  namespace: kubeflow
  imageRegistry: ghcr.io/kubeflow
  imageTag: "2.14.3"
  imagePullPolicy: Always

# Installation mode - Multi-user enabled with legacy labels
installMode:
  type: multi-user
  multiUser:
    enabled: true
    profileController:
      enabled: true
  # Legacy mode enabled - includes application-crd-id label
  legacyLabels: true

# Database Configuration - Use built-in MySQL 
mysql:
  enabled: false

postgresql:
  enabled: false

# Object Storage Configuration - Use built-in MinIO
minio:
  enabled: false

objectStore:
  provider: minio
  secure: false
  bucketName: mlpipeline

# Database names
database:
  pipelinedb: mlpipeline
  metadb: metadb
  cachedb: cachedb

# Pipeline Configuration
pipeline:
  cache:
    image: "ghcr.io/containerd/busybox"
    nodeRestrictions: false
    maximumStaleness: ""
    defaultStaleness: ""

cache:  
  server:
    additionalEnv:
      - name: NAMESPACE_TO_WATCH
        key: null
      - name: DEFAULT_CACHE_STALENESS
        key: DEFAULT_CACHE_STALENESS
      - name: MAXIMUM_CACHE_STALENESS
        key: MAXIMUM_CACHE_STALENESS
      - name: CACHE_IMAGE
        key: cacheImage
      - name: CACHE_NODE_RESTRICTIONS
        key: cacheNodeRestrictions
      - name: DBCONFIG_DRIVER
        value: "mysql"
      - name: DBCONFIG_DB_NAME
        key: cacheDb
      - name: DBCONFIG_HOST_NAME
        key: dbHost
      - name: DBCONFIG_PORT
        key: dbPort
      - name: DBCONFIG_USER
        key: username
      - name: DBCONFIG_PASSWORD
        key: password

# Argo Workflows Configuration - Enable for CRDs and subchart
argo:
  enabled: true
  crds:
    install: true
    keep: true

# Third Party Components - Enable built-in MySQL and MinIO
thirdParty:
  argo:
    enabled: true
  mysql:
    enabled: true
    secretName: "mysql-secret"
  minio:
    enabled: true
  postgresql:
    enabled: false
  # Enable separate MySQL database for metadata 
  mysqlMetadata:
    enabled: true
    image:
      repository: mysql
      tag: "8.0.3"
    database: "metadb"
    username: "root"
    password: "test"
    persistence:
      enabled: true
      size: 10Gi
  metacontroller:
    enabled: true

# Environment Configuration
env:
  platform: platform-agnostic

# Metadata Configuration
metadata:
  enabled: true
  grpc:
    image:
      repository: gcr.io/tfx-oss-public/ml_metadata_store_server
      tag: "1.14.0"

# Profile Controller Configuration
profileController:
  enabled: true
  name: ml-pipeline-profile-controller
  additionalEnv:
    - name: KFP_VERSION
      key: appVersion
    - name: KFP_DEFAULT_PIPELINE_ROOT
      key: defaultPipelineRoot
    - name: MINIO_ACCESS_KEY
      key: accesskey
    - name: MINIO_SECRET_KEY
      key: secretkey
  
  image:
    repository: kfp-profile-controller
    tag: "2.14.3"
  
  replicas: 1
  
  serviceAccount:
    create: true
    name: "ml-pipeline-profile-controller"
    annotations: {}
  
  resources:
    requests:
      cpu: 100m
      memory: 200Mi
    limits: {}

# API Server configuration
apiServer:
  env:
    publishLogs: true
    pipelineLogLevel: "1"
    # Multi-user specific headers
    kubeflowUserIdHeader: "kubeflow-userid"
    kubeflowUserIdPrefix: ""
  additionalEnv:
    - name: KUBEFLOW_USERID_HEADER
      value: "kubeflow-userid"
    - name: KUBEFLOW_USERID_PREFIX
      value: ""
    - name: PUBLISH_LOGS
      value: "true"
    - name: LOG_LEVEL
      value: "info"
    - name: PIPELINE_LOG_LEVEL
      value: "1"
    - name: AUTO_UPDATE_PIPELINE_DEFAULT_VERSION
      key: autoUpdatePipelineDefaultVersion
    - name: POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: OBJECTSTORECONFIG_SECURE
      value: "false"
    - name: OBJECTSTORECONFIG_BUCKETNAME
      key: bucketName
    - name: DBCONFIG_USER
      key: username
      secretName: mysql-secret
    - name: DBCONFIG_PASSWORD
      key: password
      secretName: mysql-secret
    - name: DBCONFIG_DBNAME
      key: pipelineDb
      configMapName: pipeline-install-config
    - name: DBCONFIG_HOST
      key: dbHost
      configMapName: pipeline-install-config
    - name: DBCONFIG_PORT
      valueFrom:
      key: dbPort
      configMapName: pipeline-install-config
    - name: DBCONFIG_CONMAXLIFETIME
      key: ConMaxLifeTime
    - name: DB_DRIVER_NAME
      key: dbType
      configMapName: pipeline-install-config
    - name: DBCONFIG_MYSQLCONFIG_USER
      key: username
    - name: DBCONFIG_MYSQLCONFIG_PASSWORD
      key: password
    - name: DBCONFIG_MYSQLCONFIG_DBNAME
      key: pipelineDb
      configMapName: pipeline-install-config
    - name: DBCONFIG_MYSQLCONFIG_HOST
      key: mysqlHost
      configMapName: pipeline-install-config
    - name: DBCONFIG_MYSQLCONFIG_PORT
      key: mysqlPort
      configMapName: pipeline-install-config
    - name: OBJECTSTORECONFIG_ACCESSKEY
      key: accesskey
      secretName: mlpipeline-minio-artifact
    - name: OBJECTSTORECONFIG_SECRETACCESSKEY
      key: secretkey
      secretName: mlpipeline-minio-artifact
    - name: V2_DRIVER_IMAGE
      value: "ghcr.io/kubeflow/kfp-driver:2.14.3"
    - name: V2_LAUNCHER_IMAGE
      value: "ghcr.io/kubeflow/kfp-launcher:2.14.3"

persistenceAgent:
  additionalEnv:
    - name: NAMESPACE
      value: ""

scheduledWorkflow:
  additionalEnv:
    - name: NAMESPACE
      value: ""
    - name: LOG_LEVEL
      value: "info"

ui:
  additionalEnv:
    - name: VIEWER_TENSORBOARD_POD_TEMPLATE_SPEC_PATH
      value: "/etc/config/viewer-pod-template.json"
    - name: DEPLOYMENT
      value: "KUBEFLOW"
    - name: ARTIFACTS_SERVICE_PROXY_NAME
      value: "ml-pipeline-ui-artifact"
    - name: ARTIFACTS_SERVICE_PROXY_PORT
      value: "80"
    - name: ARTIFACTS_SERVICE_PROXY_ENABLED
      value: "true"
    - name: ENABLE_AUTHZ
      value: "true"
    - name: KUBEFLOW_USERID_HEADER
      value: "kubeflow-userid"
    - name: KUBEFLOW_USERID_PREFIX
      value: ""
    - name: MINIO_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: MINIO_ACCESS_KEY
      key: accesskey
      secretName: mlpipeline-minio-artifact
    - name: MINIO_SECRET_KEY
      key: secretkey
      secretName: mlpipeline-minio-artifact
    - name: ALLOW_CUSTOM_VISUALIZATIONS
      value: "true"
    - name: FRONTEND_SERVER_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: ARGO_ARCHIVE_LOGS
      value: "true"
    - name: DISABLE_GKE_METADATA
      value: "true"

viewerCrd:
  additionalEnv:
    - name: NAMESPACE
      value: ""
    - name: MAX_NUM_VIEWERS
      value: "50"

# Networking Configuration
networking:
  istio:
    enabled: true
    gateway: "kubeflow-gateway"
    host: "*"
  virtualService:
    enabled: true
    prefix: "/pipeline"

