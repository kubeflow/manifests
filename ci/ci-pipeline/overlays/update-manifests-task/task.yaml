apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: update-manifests
spec:
  inputs:
    resources:
    - name: manifests
      type: git
    params:
    - name: pathToManifestsTestsDir
      type: string
      description: Where manifests tests are generated and run
      default: /workspace/manifests/tests
    - name: imageTag
      type: string
      description: tag of the image
    - name: container_image
      type: string
      description: pod container image
  outputs:
    resources:
    - name: manifests
      type: git
  steps:
  - name: update-manifests
    workingDir: "/workspace/${inputs.resources.manifests.name}/${inputs.params.pathToManifestsTestsDir}"
    image: ${inputs.params.container_image}
    command: 
    - /bin/bash
    - /kubeflow/rebuild-manifests.sh
    env:
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: /secret/kaniko-secret.json
    volumeMounts:
    - name: kaniko-secret
      mountPath: /secret
    - name: update-manifests-commands
      mountPath: /kubeflow
  volumes:
  - name: kaniko-secret
    secret:
      secretName: kaniko-secret
  - name: update-manifests-commands
    configMap:
      name: update-manifests-commands
