{{- if eq .Values.env.platform "aws" }}
{{- if .Values.env.aws.s3.enabled }}
---
# AWS S3 Configuration Patch for API Server
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "kubeflow-pipelines.fullname" . }}-aws-config
  namespace: {{ include "kubeflow-pipelines.namespace" . }}
  labels:
    {{- include "kubeflow-pipelines.labels" . | nindent 4 }}
    component: aws-config
  annotations:
    {{- include "kubeflow-pipelines.annotations" . | nindent 4 }}
data:
  # AWS S3 specific configuration
  OBJECTSTORECONFIG_SECURE: "true"
  OBJECTSTORECONFIG_HOST: "s3.amazonaws.com"
  OBJECTSTORECONFIG_REGION: {{ .Values.env.aws.s3.region | quote }}
  OBJECTSTORECONFIG_BUCKETNAME: {{ .Values.env.aws.s3.bucket | quote }}
  OBJECTSTORECONFIG_PORT: ""
{{- end }}

{{- if .Values.env.aws.iam.enabled }}
---
# AWS IAM Role Annotation for API Server Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "kubeflow-pipelines.apiServer.serviceAccountName" . }}
  namespace: {{ include "kubeflow-pipelines.namespace" . }}
  labels:
    {{- include "kubeflow-pipelines.labels" . | nindent 4 }}
    app: ml-pipeline
    component: api-server
  annotations:
    {{- include "kubeflow-pipelines.annotations" . | nindent 4 }}
    eks.amazonaws.com/role-arn: {{ .Values.env.aws.iam.apiServerRoleArn | quote }}
{{- end }}

{{- if .Values.env.aws.rds.enabled }}
---
# AWS RDS Configuration Secret
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "kubeflow-pipelines.fullname" . }}-aws-rds-secret
  namespace: {{ include "kubeflow-pipelines.namespace" . }}
  labels:
    {{- include "kubeflow-pipelines.labels" . | nindent 4 }}
    component: aws-rds
  annotations:
    {{- include "kubeflow-pipelines.annotations" . | nindent 4 }}
type: Opaque
data:
  host: {{ .Values.env.aws.rds.endpoint | b64enc }}
  port: {{ "3306" | b64enc }}
  database: {{ .Values.database.pipelinedb | b64enc }}
{{- end }}
{{- end }}
