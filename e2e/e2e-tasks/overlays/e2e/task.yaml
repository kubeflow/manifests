apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: kfctl-e2e
spec:
  inputs:
    resources:
    - name: kfctl
      type: git
      targetPath: kfctl
    - name: image
      type: image
    params:
    - name: image
      type: string
      description: the image name
    - name: project
      type: string
      description: the gcp project to run the e2e tests
    - name: bucket
      type: string
      description: name of gcp bucket to store test results
    - name: repos_dir
      type: string
      description: path to where the repo is downloaded
    - name: zone
      type: string
      description: k8 zone where e2e tests run
    - name: configPath
      type: string
      description: the location of the config file for kfctl init
    - name: email
      type: string
      description: email of project owner
    - name: platform
      type: string
      description: all | k8s
    - name: REPO_OWNER
      type: string
      description: git repository org
    - name: REPO_NAME
      type: string
      description: git repository name
    - name: config_file
      type: string
      description: the location of the prow_config file
    - name: JOB_NAME
      type: string
      description: prow job name
    - name: JOB_TYPE
      type: string
      description: presubmit | postsubmit | periodic
    - name: PULL_NUMBER
      type: string
      description: PR #
    - name: PULL_BASE_REF
      type: string
      description: master | pull id
    - name: PULL_PULL_SHA
      type: string
      description: sha of pull id
    - name: BUILD_NUMBER
      type: string
      description: build #
    - name: tests
      type: string
      description: tests
  steps:
  - name: e2e-run-tests
    image: "${inputs.params.image}"
    command: ["/bin/sleep", "infinity"]
    workingDir: /workspace/kfctl
#    command: ["python"]
#    args:
#    - "-m"
#    - "pytest"
#    - "-s"
#    - "${inputs.params.tests}"
    env:
    - name: PYTHONPATH
      value: /workspace/kubeflow/testing/py:/workspace/kubeflow/kfctl/testing
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: /secret/kaniko-secret.json
    - name: CLIENT_ID
      valueFrom:
        secretKeyRef:
          name: client-secret
          key: CLIENT_ID
    - name: CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: client-secret
          key: CLIENT_SECRET
    - name: JOB_NAME
      value: ${inputs.params.JOB_NAME}
    - name: JOB_TYPE
      value: ${inputs.params.JOB_TYPE}
    - name: PULL_NUMBER
      value: "${inputs.params.PULL_NUMBER}"
    - name: REPO_NAME
      value: "${inputs.params.REPO_NAME}"
    - name: REPO_OWNER
      value: "${inputs.params.REPO_OWNER}"
    - name: BUILD_NUMBER
      value: "${inputs.params.BUILD_NUMBER}"
    volumeMounts:
    - name: kfctl-e2e-secret
      mountPath: /secret
    - name: kubeflow
      mountPath: /kubeflow
  volumes:
  - name: kaniko-secret
    secret:
      secretName: kaniko-secret
  - name: kfctl-e2e-secret
    secret:
      secretName: kfctl-e2e-secret
  - name: kubeflow
    persistentVolumeClaim:
      claimName: kubeflow-pvc
