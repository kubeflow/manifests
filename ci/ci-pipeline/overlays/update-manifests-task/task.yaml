apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: update-manifests
spec:
  inputs:
    resources:
    - name: manifests
      type: git
    params:
    - name: pathToManifestsTestsDir
      type: string
      description: Where manifests tests are generated and run
      default: /workspace/manifests/tests
    - name: imageTag
      type: string
      description: tag of the image
  steps:
  - name: update-manifests
    workingDir: "/workspace/${inputs.resources.manifests.name}/${inputs.params.pathToManifestsTestsDir}"
    image: "golang:1.12.7"
    command: 
    - /bin/bash
    - /tmp/rebuild-manifests.sh
    env:
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: /secret/kaniko-secret.json
    volumeMounts:
    - name: kaniko-secret
      mountPath: /secret
    - name: update-manifests-commands
      mountPath: /tmp
  volumes:
  - name: kaniko-secret
    secret:
      secretName: kaniko-secret
  - name: update-manifests-commands
    configMap:
      name: update-manifests-commands
